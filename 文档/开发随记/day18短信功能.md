定时发布公告(4)

考试报名 -> 成绩的导入导出(5)	

定时发布公告(4)(不重要)（定时提醒，短信）



​	对于学生选课系统，我认为定时发布公告不太合适，因为可能由于时间的错误设置导致公告在错误的时间发送（公告一般都是提前编辑好的），可能会使一些同学看到错误的公告信息，即使之后更新公告，这些同学也不一定会得知新的公告内容。

​	所以，我选择定时提醒教师（短信系统）
​	同时，在发布公告后短信提醒同学



#### 不去集成第三方，模拟一个短信系统

​	大致思路：

​		本系统去发送短信（保存到数据库/Redis）

​		新建一个短信系统（模拟手机，可以通过手机号切换用户），用于读取数据库/Redis中的短信信息。





分为三个角色吧，

​	一个就是本来的学生选课系统，定时发送通知短信；

​		定时通知（公告到达发布时间时通知教师（必须有手机号），发布公告后通知学生）

​		智能防骚扰：相同内容30分钟内不重复发送

​		支持短信模板引擎

​			如 `{{学生姓名}}，新的公告在{{时间}}发布，请前往{{系统网址}}查看，避免错漏重要信息哦！`

​			如  `{{教师姓名}}，您有公告需要发布，请前往{{网址}}查看！`

​			支持编辑（非技术人员）

​		可以写一个自动登录，相关被通知者可以通过一个动态的链接（5min过期）快速登录到相应的界面

​		流量控制（限速100条每秒）

​		智能熔断：异常时自动切换通道

​		注意：第二个系统提供一个对外的接口，第一个系统调用该接口进行短信发送（由系统二进行数据库的保存（或许可以不保存到数据库直接利用Redis临时保存向用户发送））



​	第二个是模拟“运营商”的系统，用于接受学生选课系统发来的短信，并进行监控（可视化监控看板），然后将短信发送给第三个系统；

​		智能路由策略

			# 伪代码：模拟运营商路由逻辑
			def route_sms(sms):
	    		if sms.phone.startswith("138"):
	        		return "移动通道"
	    		elif sms.phone.startswith("189"):
	        		return "电信通道"
	    		else:
	        		return "联通通道+自动重试机制"
​		监控看板



​	第三个系统是模拟“用户手机短信”的系统，用于接受第二个系统的短信，该系统可以根据手机号进行随意切换以模拟多个用户。

​		用户手机号切换

​		全生命周期模拟

​			短信到达震动提示

​			未读小红点标记

​			滑动删除交互

​			模拟信号强度影响接收延迟

​		 话费（模拟）



#### 技术选型

RabbitMQ消息队列

​	异步削峰

​	可靠性优先

 WebSocket长连接

​	实时性要求

​	双向通信：需要模拟已读回执、回复短信等交互

​	会话保持：每个手机模拟器需要维持独立连接状态



![deepseek_mermaid_20250818_571e03](E:\Document\ChromeDocument\deepseek_mermaid_20250818_571e03.png)



#### 短信设计

```
public class SmsMessage {
    // 基础字段
    private String messageId;      // UUID
    private String sender;         // 发送方标识(如：EDU_SYS)
    private String receiver;       // 接收手机号
    private String content;        // 内容(支持模板)
    private LocalDateTime sendTime;// 发送时间
    
    // 增强字段
    private String templateId;     // 关联的模板ID

    // 状态追踪
    private SmsStatus status;      // 状态(待发送/已发送/已送达/失败)
    private String failReason;     // 失败原因
    private String operatorNote;   // 运营商备注
}
```



#### 开发步骤



1. 选课系统的短信配置页面

   1. 短信模板的编辑、选择（针对教师/学生）			1

      ​	将编辑好的模板保存在一个模板列表？集合？选择某一个

      ​		数据库设计（模板表）id、内容（包含模糊内容用{{开始}}结束，选中状态（同时只允许同一个模板类型的一个模板被选中），模板类型（教师模板、学生模板））

      ​	发送短信的时候在模板列表中拿到选中的那一个，解析模板替换模糊内容

      

   2. 智能定时发送：对于教师，在到达发布时间的前Xmin进行发送短信（默认10min）

      ​	新建一个表存储草稿箱公告id和发布的提前时间，在定时任务中来检查这个表，决定是否发送短信，注意在新建草稿箱公告时要操作该表，删除草稿箱公告也要注意，在系统启动初始化时，要将所有草稿箱公告写在该表上

   

   注意忽略时间在此时之前的

   

   下一步制作	设置按钮，设置关闭短信功能，做定时发送

   

   3. 可以选择不发送（关闭发送短信的功能）(Redis,默认是开启)

​		在系统启动初始化时，在Redis中设置一个开启短信功能的参数，在执行定时任务时，检查该参数

​	





2. 定时通知（公告到达发布时间时通知教师（必须有手机号），发布公告后通知学生）
   1. 通过运营商系统提供的接口进行发送短信（在选课系统中利用RocketMQ进行异步发送短信给该接口）
   2. 该接口负责将短信发送给用户



3. 可以写一个自动登录，相关被通知者可以通过一个动态的链接（5min过期）快速登录到相应的界面（暂时不做）



4. 流量控制（限速100条每秒）(RocketMQ中配置) （暂时不做）

​	      		 

​      

1.运营商系统的开发接口

​	接受短信，持久化

​	根据手机号进行智能路由策略（联通、电信、移动）

 	WebSocket长连接到用户系统

​	

2. 监控短信

   ​	对短信进行监控

   ​	短信总数

   ​	成功短信比例



1. 用户系统的用户短信页面（展示短信，点击短信，新短信提醒，删除短信）
2. 用户手机号切换

​		

​	

​			

